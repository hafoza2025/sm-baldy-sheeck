<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🍳 إدارة Recipes المتقدمة - نظام المطعم</title>
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/recipes-advanced.css">
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div>
      <h1>🍳 إدارة Recipes المتقدمة</h1>
      <span class="live-indicator"></span>
      <span style="font-size: 14px;">متزامن مباشرة</span>
    </div>
    <div class="user-info">
      <button class="btn btn-primary" onclick="window.location.href='admin-dashboard.html'" style="margin-left: 15px;">
        🔙 العودة للوحة التحكم
      </button>
      <span id="adminName">مرحباً، Admin</span>
      <button class="btn-logout" onclick="Auth.logout()">تسجيل خروج</button>
    </div>
  </div>

  <div class="container">
    <!-- Dashboard Statistics -->
    <div class="stats-dashboard">
      <div class="stat-card primary">
        <div class="stat-icon">📋</div>
        <div class="stat-content">
          <h3>أصناف لها Recipes</h3>
          <div class="stat-value" id="statsRecipedItems">0</div>
          <small>من إجمالي <span id="statsTotalItems">0</span> صنف</small>
        </div>
      </div>

      <div class="stat-card success">
        <div class="stat-icon">✅</div>
        <div class="stat-content">
          <h3>Recipes كاملة</h3>
          <div class="stat-value" id="statsCompleteRecipes">0</div>
          <small>جاهزة للتحضير</small>
        </div>
      </div>

      <div class="stat-card warning">
        <div class="stat-icon">⚠️</div>
        <div class="stat-content">
          <h3>مكونات منخفضة</h3>
          <div class="stat-value" id="statsLowStock">0</div>
          <small>تحتاج إعادة تموين</small>
        </div>
      </div>

      <div class="stat-card info">
        <div class="stat-icon">🧪</div>
        <div class="stat-content">
          <h3>إجمالي المكونات</h3>
          <div class="stat-value" id="statsTotalIngredients">0</div>
          <small>مكون مختلف</small>
        </div>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="recipes-layout">
      <!-- Sidebar: Menu Items -->
      <div class="menu-sidebar">
        <div class="sidebar-header">
          <h2>📋 قائمة الأصناف</h2>
          <button class="btn btn-sm btn-primary" onclick="RecipeManager.openBulkImport()">
            📥 استيراد جماعي
          </button>
        </div>

        <!-- Search & Filter -->
        <div class="search-box">
          <input type="text" id="searchMenuItem" placeholder="🔍 ابحث عن صنف..." 
                 onkeyup="RecipeManager.filterMenuItems()">
        </div>

        <div class="filter-tabs">
          <button class="filter-tab active" data-filter="all" onclick="RecipeManager.setFilter('all')">
            الكل (<span id="filterCountAll">0</span>)
          </button>
          <button class="filter-tab" data-filter="has-recipe" onclick="RecipeManager.setFilter('has-recipe')">
            لها Recipe (<span id="filterCountHas">0</span>)
          </button>
          <button class="filter-tab" data-filter="no-recipe" onclick="RecipeManager.setFilter('no-recipe')">
            بدون Recipe (<span id="filterCountNo">0</span>)
          </button>
        </div>

        <!-- Menu Items List -->
        <div class="menu-items-list" id="menuItemsList">
          <!-- يتم ملؤها ديناميكياً -->
        </div>
      </div>

      <!-- Main Content: Recipe Editor -->
      <div class="recipe-editor">
        <div class="editor-header">
          <div id="editorPlaceholder" class="editor-placeholder">
            <div class="placeholder-icon">🍽️</div>
            <h3>اختر صنفاً من القائمة</h3>
            <p>لبدء إدارة Recipe الخاصة به</p>
          </div>

          <div id="editorContent" class="editor-content" style="display: none;">
            <!-- Recipe Header -->
            <div class="recipe-header-card">
              <div class="recipe-item-info">
                <img id="recipeItemImage" src="" alt="" class="recipe-item-image">
                <div>
                  <h2 id="recipeItemName">اسم الصنف</h2>
                  <div class="recipe-meta">
                    <span class="meta-badge">💰 <span id="recipeItemPrice">0</span> جنيه</span>
                    <span class="meta-badge">📁 <span id="recipeItemCategory">فئة</span></span>
                    <span class="meta-badge" id="recipeStatus">
                      ⚠️ لا توجد وصفة
                    </span>
                  </div>
                </div>
              </div>
              <div class="recipe-actions">
                <button class="btn btn-success" onclick="RecipeManager.openAddIngredientModal()">
                  ➕ إضافة مكون
                </button>
                <button class="btn btn-export" onclick="RecipeManager.exportCurrentRecipe()">
                  📊 تصدير
                </button>
                <button class="btn btn-danger" onclick="RecipeManager.clearAllRecipe()">
                  🗑️ مسح الكل
                </button>
              </div>
            </div>

            <!-- Recipe Cost Calculator -->
            <div class="cost-calculator">
              <h3>💰 حاسبة التكلفة</h3>
              <div class="cost-grid">
                <div class="cost-item">
                  <label>تكلفة المكونات:</label>
                  <strong id="costIngredients">0.00 جنيه</strong>
                </div>
                <div class="cost-item">
                  <label>هامش الربح:</label>
                  <input type="number" id="profitMargin" value="200" min="0" step="10" 
                         onchange="RecipeManager.calculateCosts()" style="width: 80px;">
                  <span>%</span>
                </div>
                <div class="cost-item success">
                  <label>السعر المقترح:</label>
                  <strong id="suggestedPrice">0.00 جنيه</strong>
                </div>
                <div class="cost-item">
                  <label>السعر الحالي:</label>
                  <strong id="currentPrice">0.00 جنيه</strong>
                </div>
              </div>
            </div>

            <!-- Ingredients Table -->
            <div class="ingredients-section">
              <h3>🧪 مكونات Recipe</h3>
              
              <div id="emptyRecipeState" class="empty-state">
                <p>لا توجد مكونات في هذه الوصفة</p>
                <button class="btn btn-primary" onclick="RecipeManager.openAddIngredientModal()">
                  ➕ ابدأ بإضافة المكونات
                </button>
              </div>

              <div id="ingredientsTable" style="display: none;">
                <table class="ingredients-table">
                  <thead>
                    <tr>
                      <th width="35%">المكون</th>
                      <th width="15%">الكمية المطلوبة</th>
                      <th width="15%">المخزون الحالي</th>
                      <th width="15%">التكلفة</th>
                      <th width="10%">الحالة</th>
                      <th width="10%">الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody id="ingredientsBody">
                    <!-- يتم ملؤها ديناميكياً -->
                  </tbody>
                  <tfoot>
                    <tr class="total-row">
                      <td colspan="3"><strong>الإجمالي:</strong></td>
                      <td><strong id="totalCost">0.00 جنيه</strong></td>
                      <td colspan="2"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            <!-- Recipe Instructions -->
            <div class="instructions-section">
              <h3>📝 ملاحظات التحضير</h3>
              <textarea id="recipeInstructions" rows="4" 
                        placeholder="أضف ملاحظات أو تعليمات التحضير (اختياري)..."
                        onchange="RecipeManager.saveInstructions()"></textarea>
            </div>

            <!-- Kitchen Preview -->
            <div class="kitchen-preview">
              <h3>👨‍🍳 معاينة المطبخ</h3>
              <div class="preview-card">
                <p>هذا ما سيراه الطاقم في شاشة المطبخ:</p>
                <div class="kitchen-card-preview" id="kitchenPreview">
                  <!-- يتم ملؤها ديناميكياً -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Inventory Status -->
      <div class="inventory-panel">
        <div class="panel-header">
          <h2>📦 حالة المخزون</h2>
          <button class="btn btn-sm btn-refresh" onclick="RecipeManager.refreshInventory()">
            🔄
          </button>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
          <div class="quick-stat green">
            <div class="stat-label">متوفر</div>
            <div class="stat-number" id="quickStatsAvailable">0</div>
          </div>
          <div class="quick-stat orange">
            <div class="stat-label">منخفض</div>
            <div class="stat-number" id="quickStatsLow">0</div>
          </div>
          <div class="quick-stat red">
            <div class="stat-label">حرج</div>
            <div class="stat-number" id="quickStatsCritical">0</div>
          </div>
        </div>

        <!-- Inventory List -->
        <div class="inventory-list" id="inventoryList">
          <!-- يتم ملؤها ديناميكياً -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Add Ingredient to Recipe -->
  <div id="addIngredientModal" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>➕ إضافة مكون للـ Recipe</h2>
        <span class="close-modal" onclick="RecipeManager.closeAddIngredientModal()">×</span>
      </div>
      
      <form id="addIngredientForm">
        <div class="ingredient-selector">
          <div class="form-group">
            <label>اختر المكون *</label>
            <select id="ingredientSelect" required onchange="RecipeManager.ingredientSelected()">
              <option value="">-- اختر المكون --</option>
            </select>
          </div>

          <div id="ingredientDetails" class="ingredient-details" style="display: none;">
            <div class="detail-grid">
              <div class="detail-item">
                <label>الوحدة:</label>
                <span id="detailUnit">-</span>
              </div>
              <div class="detail-item">
                <label>المخزون الحالي:</label>
                <span id="detailStock">-</span>
              </div>
              <div class="detail-item">
                <label>التكلفة/الوحدة:</label>
                <span id="detailCost">-</span>
              </div>
              <div class="detail-item">
                <label>الحالة:</label>
                <span id="detailStatus">-</span>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>الكمية المطلوبة (لقطعة واحدة) *</label>
          <div class="quantity-input-group">
            <input type="number" id="ingredientQuantity" step="0.001" min="0.001" required 
                   onchange="RecipeManager.calculateIngredientCost()">
            <span class="unit-label" id="quantityUnit">وحدة</span>
          </div>
          <small class="help-text">الكمية المطلوبة لتحضير وحدة واحدة من الصنف</small>
        </div>

        <div class="cost-preview">
          <div class="cost-preview-item">
            <label>تكلفة هذا المكون:</label>
            <strong id="previewCost">0.00 جنيه</strong>
          </div>
          <div class="cost-preview-item">
            <label>يكفي لعدد:</label>
            <strong id="previewServings">0 قطعة</strong>
          </div>
        </div>

        <button type="submit" class="btn btn-success btn-block">
          ✅ إضافة المكون للـ Recipe
        </button>
      </form>
    </div>
  </div>

  <!-- Modal: Edit Ingredient -->
  <div id="editIngredientModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>✏️ تعديل المكون</h2>
        <span class="close-modal" onclick="RecipeManager.closeEditIngredientModal()">×</span>
      </div>
      
      <form id="editIngredientForm">
        <input type="hidden" id="editRecipeId">
        
        <div class="form-group">
          <label>المكون</label>
          <input type="text" id="editIngredientName" readonly>
        </div>

        <div class="form-group">
          <label>الكمية المطلوبة *</label>
          <div class="quantity-input-group">
            <input type="number" id="editIngredientQuantity" step="0.001" min="0.001" required>
            <span class="unit-label" id="editQuantityUnit">وحدة</span>
          </div>
        </div>

        <button type="submit" class="btn btn-success btn-block">
          ✅ حفظ التعديلات
        </button>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="config/keys.js"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/realtime.js"></script>
  <script src="js/recipes-advanced.js"></script>
  
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      RecipeManager.init();
    });
  </script>

  <!-- زر Refresh + مؤشر الاتصال -->
  <!-- الصق الكود من الرد السابق هنا -->
</body>
</html>
