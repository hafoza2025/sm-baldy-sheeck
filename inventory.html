<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🍳 إدارة Recipes والمخزون - نظام المطعم</title>
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/inventory.css">
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div>
      <h1>🍳 إدارة Recipes والمخزون المتقدمة</h1>
      <span class="live-indicator"></span>
      <span style="font-size: 14px;">متزامن مباشرة</span>
    </div>
    <div class="user-info">
      <!-- أزرار التبديل -->
      <div class="view-switcher" style="display: flex; gap: 10px; margin-left: 15px;">
        <button class="btn btn-primary active" id="btnRecipeView" onclick="RecipeManager.switchView('recipe')">
          🍳 Recipes
        </button>
        <button class="btn btn-primary" id="btnInventoryView" onclick="RecipeManager.switchView('inventory')">
          📦 المخزون
        </button>
      </div>
      
      <button class="btn btn-primary" onclick="window.location.href='admin-dashboard.html'" style="margin-left: 15px;">
        🔙 لوحة التحكم
      </button>
      <span id="adminName">مرحباً، Admin</span>
      <button class="btn-logout" onclick="Auth.logout()">تسجيل خروج</button>
    </div>
  </div>

  <div class="container">
    <!-- Dashboard Statistics -->
    <div class="stats-dashboard">
      <div class="stat-card primary">
        <div class="stat-icon">📋</div>
        <div class="stat-content">
          <h3>أصناف لها Recipes</h3>
          <div class="stat-value" id="statsRecipedItems">0</div>
          <small>من إجمالي <span id="statsTotalItems">0</span> صنف</small>
        </div>
      </div>

      <div class="stat-card success">
        <div class="stat-icon">✅</div>
        <div class="stat-content">
          <h3>Recipes كاملة</h3>
          <div class="stat-value" id="statsCompleteRecipes">0</div>
          <small>جاهزة للتحضير</small>
        </div>
      </div>

      <div class="stat-card warning">
        <div class="stat-icon">⚠️</div>
        <div class="stat-content">
          <h3>مكونات منخفضة</h3>
          <div class="stat-value" id="statsLowStock">0</div>
          <small>تحتاج إعادة تموين</small>
        </div>
      </div>

      <div class="stat-card info">
        <div class="stat-icon">🧪</div>
        <div class="stat-content">
          <h3>إجمالي المكونات</h3>
          <div class="stat-value" id="statsTotalIngredients">0</div>
          <small>مكون مختلف</small>
        </div>
      </div>
    </div>

    <!-- Recipe View (الواجهة الأصلية) -->
    <div class="recipes-layout" id="recipeView">
      <!-- Menu Sidebar -->
      <div class="menu-sidebar">
        <div class="sidebar-header">
          <h2>📋 قائمة الأصناف</h2>
        </div>

        <div class="search-box">
          <input type="text" id="searchMenuItem" placeholder="🔍 ابحث عن صنف..." 
                 onkeyup="RecipeManager.filterMenuItems()">
        </div>

        <div class="filter-tabs">
          <button class="filter-tab active" data-filter="all" onclick="RecipeManager.setFilter('all')">
            الكل (<span id="filterCountAll">0</span>)
          </button>
          <button class="filter-tab" data-filter="has-recipe" onclick="RecipeManager.setFilter('has-recipe')">
            لها Recipe (<span id="filterCountHas">0</span>)
          </button>
          <button class="filter-tab" data-filter="no-recipe" onclick="RecipeManager.setFilter('no-recipe')">
            بدون Recipe (<span id="filterCountNo">0</span>)
          </button>
        </div>

        <div class="menu-items-list" id="menuItemsList"></div>
      </div>

      <!-- Recipe Editor -->
      <div class="recipe-editor">
        <div class="editor-header">
          <div id="editorPlaceholder" class="editor-placeholder">
            <div class="placeholder-icon">🍽️</div>
            <h3>اختر صنفاً من القائمة</h3>
            <p>لبدء إدارة Recipe الخاصة به</p>
          </div>

          <div id="editorContent" class="editor-content" style="display: none;">
            <!-- Recipe Header -->
            <div class="recipe-header-card">
              <div class="recipe-item-info">
                <img id="recipeItemImage" src="" alt="" class="recipe-item-image">
                <div>
                  <h2 id="recipeItemName">اسم الصنف</h2>
                  <div class="recipe-meta">
                    <span class="meta-badge">💰 <span id="recipeItemPrice">0</span> جنيه</span>
                    <span class="meta-badge">📁 <span id="recipeItemCategory">فئة</span></span>
                    <span class="meta-badge" id="recipeStatus">⚠️ لا توجد وصفة</span>
                  </div>
                </div>
              </div>
              <div class="recipe-actions">
                <button class="btn btn-success" onclick="RecipeManager.openAddIngredientModal()">
                  ➕ إضافة مكون
                </button>
                <button class="btn btn-export" onclick="RecipeManager.exportCurrentRecipe()">
                  📊 تصدير
                </button>
                <button class="btn btn-danger" onclick="RecipeManager.clearAllRecipe()">
                  🗑️ مسح الكل
                </button>
              </div>
            </div>

            <!-- Cost Calculator -->
            <div class="cost-calculator">
              <h3>💰 حاسبة التكلفة</h3>
              <div class="cost-grid">
                <div class="cost-item">
                  <label>تكلفة المكونات:</label>
                  <strong id="costIngredients">0.00 جنيه</strong>
                </div>
                <div class="cost-item">
                  <label>هامش الربح:</label>
                  <input type="number" id="profitMargin" value="200" min="0" step="10" 
                         onchange="RecipeManager.calculateCosts()" style="width: 80px;">
                  <span>%</span>
                </div>
                <div class="cost-item success">
                  <label>السعر المقترح:</label>
                  <strong id="suggestedPrice">0.00 جنيه</strong>
                </div>
                <div class="cost-item">
                  <label>السعر الحالي:</label>
                  <strong id="currentPrice">0.00 جنيه</strong>
                </div>
              </div>
            </div>

            <!-- Ingredients Table -->
            <div class="ingredients-section">
              <h3>🧪 مكونات Recipe</h3>
              
              <div id="emptyRecipeState" class="empty-state">
                <p>لا توجد مكونات في هذه الوصفة</p>
                <button class="btn btn-primary" onclick="RecipeManager.openAddIngredientModal()">
                  ➕ ابدأ بإضافة المكونات
                </button>
              </div>

              <div id="ingredientsTable" style="display: none;">
                <table class="ingredients-table">
                  <thead>
                    <tr>
                      <th width="35%">المكون</th>
                      <th width="15%">الكمية المطلوبة</th>
                      <th width="15%">المخزون الحالي</th>
                      <th width="15%">التكلفة</th>
                      <th width="10%">الحالة</th>
                      <th width="10%">الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody id="ingredientsBody"></tbody>
                  <tfoot>
                    <tr class="total-row">
                      <td colspan="3"><strong>الإجمالي:</strong></td>
                      <td><strong id="totalCost">0.00 جنيه</strong></td>
                      <td colspan="2"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            <!-- Kitchen Preview -->
            <div class="kitchen-preview">
              <h3>👨‍🍳 معاينة المطبخ</h3>
              <div class="preview-card">
                <p>هذا ما سيراه الطاقم في شاشة المطبخ:</p>
                <div class="kitchen-card-preview" id="kitchenPreview"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Inventory Panel -->
      <div class="inventory-panel">
        <div class="panel-header">
          <h2>📦 حالة المخزون</h2>
          <button class="btn btn-sm btn-refresh" onclick="RecipeManager.refreshInventory()">🔄</button>
        </div>

        <div class="quick-stats">
          <div class="quick-stat green">
            <div class="stat-label">متوفر</div>
            <div class="stat-number" id="quickStatsAvailable">0</div>
          </div>
          <div class="quick-stat orange">
            <div class="stat-label">منخفض</div>
            <div class="stat-number" id="quickStatsLow">0</div>
          </div>
          <div class="quick-stat red">
            <div class="stat-label">حرج</div>
            <div class="stat-number" id="quickStatsCritical">0</div>
          </div>
        </div>

        <div class="inventory-list" id="inventoryList"></div>
      </div>
    </div>

    <!-- Inventory Management View (جديد) -->
    <div class="inventory-management-section" style="display: none;" id="inventoryView">
      <div class="section-header">
        <h2>📦 إدارة المخزون الكاملة</h2>
        <div class="section-actions">
          <button class="btn btn-success" onclick="RecipeManager.openAddInventoryModal()">
            ➕ إضافة مكون جديد
          </button>
          <button class="btn btn-export" onclick="RecipeManager.exportInventory()">
            📊 تصدير Excel
          </button>
        </div>
      </div>

      <div class="inventory-filters">
        <input type="text" id="inventorySearch" placeholder="🔍 ابحث عن مكون..." 
               onkeyup="RecipeManager.filterInventory()">
        <select id="inventoryStatusFilter" onchange="RecipeManager.filterInventory()">
          <option value="all">جميع الحالات</option>
          <option value="ok">✅ متوفر</option>
          <option value="low">⚠️ منخفض</option>
          <option value="critical">🔴 حرج</option>
        </select>
      </div>

      <div class="inventory-table-container">
        <table class="inventory-table">
          <thead>
            <tr>
              <th width="25%">المكون</th>
              <th width="12%">الكمية الحالية</th>
              <th width="10%">الحد الأدنى</th>
              <th width="12%">التكلفة/الوحدة</th>
              <th width="12%">القيمة الإجمالية</th>
              <th width="12%">المورد</th>
              <th width="10%">الحالة</th>
              <th width="7%">الإجراءات</th>
            </tr>
          </thead>
          <tbody id="inventoryTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modals -->
  
  <!-- Modal: Add Ingredient to Recipe -->
  <div id="addIngredientModal" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>➕ إضافة مكون للـ Recipe</h2>
        <span class="close-modal" onclick="RecipeManager.closeAddIngredientModal()">×</span>
      </div>
      
      <form id="addIngredientForm">
        <div class="ingredient-selector">
          <div class="form-group">
            <label>اختر المكون *</label>
            <select id="ingredientSelect" required onchange="RecipeManager.ingredientSelected()">
              <option value="">-- اختر المكون --</option>
            </select>
          </div>

          <div id="ingredientDetails" class="ingredient-details" style="display: none;">
            <div class="detail-grid">
              <div class="detail-item">
                <label>الوحدة:</label>
                <span id="detailUnit">-</span>
              </div>
              <div class="detail-item">
                <label>المخزون الحالي:</label>
                <span id="detailStock">-</span>
              </div>
              <div class="detail-item">
                <label>التكلفة/الوحدة:</label>
                <span id="detailCost">-</span>
              </div>
              <div class="detail-item">
                <label>الحالة:</label>
                <span id="detailStatus">-</span>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>الكمية المطلوبة (لقطعة واحدة) *</label>
          <div class="quantity-input-group">
            <input type="number" id="ingredientQuantity" step="0.001" min="0.001" required 
                   onchange="RecipeManager.calculateIngredientCost()">
            <span class="unit-label" id="quantityUnit">وحدة</span>
          </div>
          <small class="help-text">الكمية المطلوبة لتحضير وحدة واحدة من الصنف</small>
        </div>

        <div class="cost-preview">
          <div class="cost-preview-item">
            <label>تكلفة هذا المكون:</label>
            <strong id="previewCost">0.00 جنيه</strong>
          </div>
          <div class="cost-preview-item">
            <label>يكفي لعدد:</label>
            <strong id="previewServings">0 قطعة</strong>
          </div>
        </div>

        <button type="submit" class="btn btn-success btn-block">
          ✅ إضافة المكون للـ Recipe
        </button>
      </form>
    </div>
  </div>

  <!-- Modal: Edit Recipe Ingredient -->
  <div id="editIngredientModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>✏️ تعديل المكون</h2>
        <span class="close-modal" onclick="RecipeManager.closeEditIngredientModal()">×</span>
      </div>
      
      <form id="editIngredientForm">
        <input type="hidden" id="editRecipeId">
        
        <div class="form-group">
          <label>المكون</label>
          <input type="text" id="editIngredientName" readonly>
        </div>

        <div class="form-group">
          <label>الكمية المطلوبة *</label>
          <div class="quantity-input-group">
            <input type="number" id="editIngredientQuantity" step="0.001" min="0.001" required>
            <span class="unit-label" id="editQuantityUnit">وحدة</span>
          </div>
        </div>

        <button type="submit" class="btn btn-success btn-block">
          ✅ حفظ التعديلات
        </button>
      </form>
    </div>
  </div>

  <!-- Modal: Add Inventory Item -->
  <div id="addInventoryModal" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>➕ إضافة مكون جديد للمخزون</h2>
        <span class="close-modal" onclick="RecipeManager.closeAddInventoryModal()">×</span>
      </div>
      
      <form id="addInventoryForm">
        <div class="form-row">
          <div class="form-group">
            <label>اسم المكون *</label>
            <input type="text" id="newIngredientName" required placeholder="مثال: دجاج، أرز، زيت">
          </div>

          <div class="form-group">
            <label>الوحدة *</label>
            <select id="newIngredientUnit" required>
              <option value="">-- اختر --</option>
              <option value="كجم">كيلوجرام (كجم)</option>
              <option value="جرام">جرام</option>
              <option value="لتر">لتر</option>
              <option value="مل">مليلتر (مل)</option>
              <option value="قطعة">قطعة</option>
              <option value="رغيف">رغيف</option>
              <option value="علبة">علبة</option>
              <option value="كيس">كيس</option>
              <option value="حزمة">حزمة</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>الكمية الحالية *</label>
            <input type="number" id="newIngredientStock" step="0.01" min="0" required 
                   oninput="RecipeManager.calculateInventorySummary()">
          </div>

          <div class="form-group">
            <label>الحد الأدنى *</label>
            <input type="number" id="newIngredientMinStock" step="0.01" min="0" required>
            <small class="help-text">سيتم التنبيه عند الوصول لهذا الحد</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>التكلفة لكل وحدة (جنيه) *</label>
            <input type="number" id="newIngredientCost" step="0.01" min="0" required 
                   oninput="RecipeManager.calculateInventorySummary()">
          </div>

          <div class="form-group">
            <label>المورد</label>
            <input type="text" id="newIngredientSupplier" placeholder="اختياري">
          </div>
        </div>

        <div class="cost-summary" style="background: #e8ecff; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <h4 style="margin: 0 0 10px 0;">📊 ملخص التكلفة</h4>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            <div>
              <label>الكمية:</label>
              <strong id="summaryQuantity">0</strong>
            </div>
            <div>
              <label>التكلفة الإجمالية:</label>
              <strong id="summaryCost">0.00 جنيه</strong>
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-success btn-block">
          ✅ إضافة المكون
        </button>
      </form>
    </div>
  </div>

  <!-- Modal: Update Stock -->
  <div id="updateStockModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>📦 تحديث المخزون</h2>
        <span class="close-modal" onclick="RecipeManager.closeUpdateStockModal()">×</span>
      </div>
      
      <form id="updateStockForm">
        <input type="hidden" id="updateIngredientId">
        
        <div class="form-group">
          <label>المكون</label>
          <input type="text" id="updateIngredientName" readonly>
        </div>

        <div class="form-group">
          <label>الكمية الحالية</label>
          <div style="padding: 12px; background: #f9f9f9; border-radius: 6px; font-weight: bold;">
            <span id="updateCurrentStock">0</span>
          </div>
        </div>

        <div class="form-group">
          <label>نوع العملية *</label>
          <select id="updateStockType" required onchange="RecipeManager.updateStockTypeChanged()">
            <option value="add">➕ إضافة للمخزون</option>
            <option value="deduct">➖ خصم من المخزون</option>
            <option value="set">⚙️ تعيين الكمية</option>
          </select>
        </div>

        <div class="form-group">
          <label id="updateQuantityLabel">الكمية *</label>
          <input type="number" id="updateQuantity" step="0.01" min="0" required 
                 oninput="RecipeManager.calculateNewStock()">
        </div>

        <div class="form-group">
          <label>الكمية الجديدة</label>
          <div style="padding: 12px; background: #d4edda; border-radius: 6px; font-weight: bold; color: #155724;">
            <span id="updateNewStock">0</span>
          </div>
        </div>

        <div class="form-group">
          <label>ملاحظات</label>
          <textarea id="updateNotes" rows="3" placeholder="سبب التحديث (اختياري)"></textarea>
        </div>

        <button type="submit" class="btn btn-success btn-block">
          ✅ تحديث المخزون
        </button>
      </form>
    </div>
  </div>

  <!-- Modal: Edit Inventory Item -->
  <div id="editInventoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>✏️ تعديل المكون</h2>
        <span class="close-modal" onclick="RecipeManager.closeEditInventoryModal()">×</span>
      </div>
      
      <form id="editInventoryForm">
        <input type="hidden" id="editInventoryId">
        
        <div class="form-group">
          <label>اسم المكون *</label>
          <input type="text" id="editInventoryName" required>
        </div>

        <div class="form-group">
          <label>الوحدة *</label>
          <select id="editInventoryUnit" required>
            <option value="كجم">كيلوجرام (كجم)</option>
            <option value="جرام">جرام</option>
            <option value="لتر">لتر</option>
            <option value="مل">مليلتر (مل)</option>
            <option value="قطعة">قطعة</option>
            <option value="رغيف">رغيف</option>
            <option value="علبة">علبة</option>
            <option value="كيس">كيس</option>
            <option value="حزمة">حزمة</option>
          </select>
        </div>

        <div class="form-group">
          <label>الحد الأدنى *</label>
          <input type="number" id="editInventoryMinStock" step="0.01" min="0" required>
        </div>

        <div class="form-group">
          <label>التكلفة/الوحدة *</label>
          <input type="number" id="editInventoryCost" step="0.01" min="0" required>
        </div>

        <div class="form-group">
          <label>المورد</label>
          <input type="text" id="editInventorySupplier">
        </div>

        <button type="submit" class="btn btn-success btn-block">
          ✅ حفظ التعديلات
        </button>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="config/keys.js"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/realtime.js"></script>
  <script src="js/inventory.js"></script>
  
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      RecipeManager.init();
    });
  </script>

  <!-- زر Refresh + مؤشر الاتصال (ضع الكود الكامل من الرد السابق) -->
  
</body>
</html>
