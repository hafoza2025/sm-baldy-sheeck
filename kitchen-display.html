<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø·Ø¨Ø® - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø¹Ù…</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/kitchen.css">
</head>

<body>
    <div class="kitchen-header">
        <h1>ğŸ‘¨â€ğŸ³ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø·Ø¨Ø®</h1>
        <div class="live-indicator"></div>
        <span style="font-size: 14px;">Ù…Ø¨Ø§Ø´Ø±</span>
    </div>

    <div class="status-tabs">
        <button class="status-tab active" data-status="all" onclick="KitchenDisplay.filterOrders('all')">
            Ø§Ù„ÙƒÙ„
        </button>
        <button class="status-tab" data-status="new" onclick="KitchenDisplay.filterOrders('new')">
            Ø¬Ø¯ÙŠØ¯
        </button>
        <button class="status-tab" data-status="preparing" onclick="KitchenDisplay.filterOrders('preparing')">
            Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±
        </button>
        <button class="status-tab" data-status="ready" onclick="KitchenDisplay.filterOrders('ready')">
            Ø¬Ø§Ù‡Ø²
        </button>
    </div>

    <div class="orders-container" id="ordersContainer">
        <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªÙØ¹Ø±Ø¶ Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ø·Ø¨Ø§Ø¹Ø© Recipe -->
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config/keys.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/realtime.js"></script>
    <script src="js/kitchen.js"></script>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            KitchenDisplay.init();
            console.log('âœ… Kitchen Display with Recipe Printing ready');
        });
    </script>

    <!-- ===================================
     Ø²Ø± Refresh + Ù…Ø¤Ø´Ø± Ø§Ù„Ø§ØªØµØ§Ù„
     =================================== -->
    <style>
      /* Ø²Ø± Refresh Ø§Ù„Ø¹Ø§Ø¦Ù… */
      .refresh-widget {
        position: fixed;
        bottom: 30px;
        right: 30px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 9998;
      }

      .refresh-btn-main {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 26px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .refresh-btn-main:hover {
        transform: scale(1.1) rotate(15deg);
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.7);
      }

      .refresh-btn-main:active {
        transform: scale(0.95);
      }

      .refresh-btn-main.refreshing {
        animation: rotate360 1s linear infinite;
        pointer-events: none;
        opacity: 0.7;
      }

      @keyframes rotate360 {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .refresh-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #f44336;
        color: white;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        font-size: 11px;
        font-weight: bold;
        display: none;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        animation: pulse-badge 2s infinite;
      }

      .refresh-badge.show {
        display: flex;
      }

      @keyframes pulse-badge {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.15); }
      }

      .connection-status {
        background: white;
        padding: 10px 15px;
        border-radius: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .connection-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        animation: pulse-dot 2s infinite;
      }

      .connection-status.connected .connection-dot {
        background: #4caf50;
      }

      .connection-status.disconnected .connection-dot {
        background: #f44336;
        animation: blink 1s infinite;
      }

      .connection-status.checking .connection-dot {
        background: #ff9800;
      }

      @keyframes pulse-dot {
        0%, 100% { 
          box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
        }
        50% { 
          box-shadow: 0 0 0 6px rgba(76, 175, 80, 0);
        }
      }

      @keyframes blink {
        0%, 50%, 100% { opacity: 1; }
        25%, 75% { opacity: 0.3; }
      }

      .refresh-toast {
        position: fixed;
        bottom: 110px;
        right: 30px;
        background: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        z-index: 9997;
        transform: translateX(150%);
        transition: transform 0.3s ease;
        border-right: 4px solid #667eea;
      }

      .refresh-toast.show {
        transform: translateX(0);
      }

      .refresh-toast.success {
        border-right-color: #4caf50;
      }

      .refresh-toast.error {
        border-right-color: #f44336;
      }

      .last-refresh-time {
        position: fixed;
        bottom: 110px;
        right: 105px;
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 11px;
        color: #666;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      .refresh-btn-main:hover + .last-refresh-time {
        opacity: 1;
      }

      @media (max-width: 768px) {
        .refresh-widget {
          bottom: 20px;
          right: 20px;
        }

        .refresh-btn-main {
          width: 50px;
          height: 50px;
          font-size: 22px;
        }

        .connection-status {
          font-size: 11px;
          padding: 8px 12px;
        }

        .refresh-toast {
          bottom: 90px;
          right: 20px;
          left: 20px;
        }
      }
    </style>

    <div class="refresh-widget">
      <button class="refresh-btn-main" id="refreshBtn" onclick="refreshData()" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
        ğŸ”„
        <span class="refresh-badge" id="refreshBadge">0</span>
      </button>
      <div class="last-refresh-time" id="lastRefreshTime">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: Ù…Ù†Ø° Ù„Ø­Ø¸Ø§Øª</div>
      
      <div class="connection-status checking" id="connectionStatus">
        <span class="connection-dot"></span>
        <span id="connectionText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span>
      </div>
    </div>

    <div class="refresh-toast" id="refreshToast">
      ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­ âœ…
    </div>

    <script>
    let isRefreshing = false;
    let lastRefreshTime = null;
    let pendingUpdates = 0;
    let connectionCheckInterval = null;

    async function checkConnection() {
      const statusElement = document.getElementById('connectionStatus');
      const textElement = document.getElementById('connectionText');
      
      try {
        const { error } = await supabase
          .from('orders')
          .select('id')
          .limit(1);
        
        if (error) throw error;
        
        statusElement.className = 'connection-status connected';
        textElement.textContent = 'Ù…ØªØµÙ„';
        return true;
        
      } catch (error) {
        statusElement.className = 'connection-status disconnected';
        textElement.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
        console.error('Connection error:', error);
        return false;
      }
    }

    async function refreshData() {
      if (isRefreshing) {
        showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...', 'success');
        return;
      }
      
      isRefreshing = true;
      const btn = document.getElementById('refreshBtn');
      const badge = document.getElementById('refreshBadge');
      
      btn.classList.add('refreshing');
      showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'success');
      
      try {
        if (typeof KitchenDisplay !== 'undefined' && KitchenDisplay.loadOrders) {
          await KitchenDisplay.loadOrders();
        }
        
        lastRefreshTime = Date.now();
        pendingUpdates = 0;
        badge.textContent = '0';
        badge.classList.remove('show');
        
        updateLastRefreshTime();
        showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
        await checkConnection();
        
      } catch (error) {
        console.error('Refresh error:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« âŒ', 'error');
      } finally {
        isRefreshing = false;
        btn.classList.remove('refreshing');
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('refreshToast');
      toast.textContent = message;
      toast.className = `refresh-toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function updateLastRefreshTime() {
      if (!lastRefreshTime) return;
      
      const timeElement = document.getElementById('lastRefreshTime');
      const now = Date.now();
      const diff = Math.floor((now - lastRefreshTime) / 1000);
      
      let timeText = '';
      if (diff < 60) {
        timeText = 'Ù…Ù†Ø° Ù„Ø­Ø¸Ø§Øª';
      } else if (diff < 3600) {
        timeText = `Ù…Ù†Ø° ${Math.floor(diff / 60)} Ø¯Ù‚ÙŠÙ‚Ø©`;
      } else {
        timeText = `Ù…Ù†Ø° ${Math.floor(diff / 3600)} Ø³Ø§Ø¹Ø©`;
      }
      
      timeElement.textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${timeText}`;
    }

    function incrementPendingUpdates() {
      pendingUpdates++;
      const badge = document.getElementById('refreshBadge');
      badge.textContent = pendingUpdates > 99 ? '99+' : pendingUpdates;
      badge.classList.add('show');
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'F5' || (e.ctrlKey && e.key === 'r') || (e.metaKey && e.key === 'r')) {
        e.preventDefault();
        refreshData();
      }
    });

    window.addEventListener('DOMContentLoaded', async () => {
      await checkConnection();
      connectionCheckInterval = setInterval(checkConnection, 30000);
      setInterval(() => { refreshData(); }, 60 * 1000);
      setInterval(updateLastRefreshTime, 60000);
      lastRefreshTime = Date.now();
    });

    window.addEventListener('beforeunload', () => {
      if (connectionCheckInterval) {
        clearInterval(connectionCheckInterval);
      }
    });

    if (typeof Realtime !== 'undefined') {
      const originalSubscribe = Realtime.subscribeToOrders;
      if (originalSubscribe) {
        Realtime.subscribeToOrders = function(callback) {
          return originalSubscribe.call(this, (payload) => {
            if (payload.eventType === 'INSERT') {
              incrementPendingUpdates();
            }
            callback(payload);
          });
        };
      }
    }

    console.log('âœ… Refresh system initialized');
    </script>
    <!-- Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ </body> -->

<script>
  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Utils
  window.addEventListener('DOMContentLoaded', () => {
    KitchenDisplay.init();
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ù„Ù„Ù€ Recipes
    console.log('âœ… Kitchen Display with Recipe Printing initialized');
  });
</script>


</body>
</html>

