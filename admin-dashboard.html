<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎛️ لوحة تحكم المدير - نظام المطعم</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <div class="header">
        <div>
            <h1>🎛️ لوحة تحكم المدير</h1>
            <span class="live-indicator"></span>
            <span style="font-size: 14px;">مباشر • لحظي</span>
        </div>
        <div class="user-info">
            <a href="inventory.html" class="btn btn-primary" style="margin-left: 15px; background: rgba(255,255,255,0.2); border: 2px solid white; padding: 8px 16px; border-radius: 6px; text-decoration: none; color: white; font-weight: 600;">
                🍳 إدارة Recipes
            </a>
            <a href="accounting.html" class="btn btn-primary" style="margin-left: 15px;">💼 المحاسبة</a>
            <span id="adminName">مرحباً، Admin</span>
            <button class="btn-logout" onclick="Auth.logout()">تسجيل خروج</button>
        </div>
    </div>

    <div class="container">
        <!-- الإحصائيات الرئيسية اللحظية -->
        <div class="stats-grid" style="margin-bottom: 30px;">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                <h3 style="color: rgba(255,255,255,0.9);">💰 إيرادات اليوم</h3>
                <div class="value" style="color: white; font-size: 36px;" id="todayRevenue">0 جنيه</div>
                <div class="change" style="color: rgba(255,255,255,0.9); font-size: 13px;">
                    <span id="revenueChange">+0%</span> عن الأمس
                </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none;">
                <h3 style="color: rgba(255,255,255,0.9);">📋 طلبات اليوم</h3>
                <div class="value" style="color: white; font-size: 36px;" id="todayOrdersCount">0</div>
                <div class="change" style="color: rgba(255,255,255,0.9); font-size: 13px;">
                    متوسط الفاتورة: <span id="avgOrderValue">0 جنيه</span>
                </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none;">
                <h3 style="color: rgba(255,255,255,0.9);">🔥 طلبات نشطة الآن</h3>
                <div class="value" style="color: white; font-size: 36px;" id="activeOrders">0</div>
                <div class="change" style="color: rgba(255,255,255,0.9); font-size: 13px;">
                    جديد: <span id="newOrders">0</span> • قيد التحضير: <span id="preparingOrders">0</span>
                </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; border: none;">
                <h3 style="color: rgba(255,255,255,0.9);">💵 صافي الربح اليوم</h3>
                <div class="value" style="color: white; font-size: 36px;" id="todayProfit">0 جنيه</div>
                <div class="change" style="color: rgba(255,255,255,0.9); font-size: 13px;">
                    هامش: <span id="profitMargin">0%</span>
                </div>
            </div>
        </div>

        <!-- المبيعات والتكاليف -->
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 20px;">📊 ملخص المبيعات والتكاليف</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="tab-btn active" onclick="AdminDashboard.setTimeFilter('today')" style="padding: 8px 16px; font-size: 14px;">اليوم</button>
                    <button class="tab-btn" onclick="AdminDashboard.setTimeFilter('week')" style="padding: 8px 16px; font-size: 14px;">الأسبوع</button>
                    <button class="tab-btn" onclick="AdminDashboard.setTimeFilter('month')" style="padding: 8px 16px; font-size: 14px;">الشهر</button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; border-right: 4px solid #667eea;">
                    <div style="font-size: 13px; color: #666; margin-bottom: 5px;">إجمالي المبيعات</div>
                    <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="totalSales">0 جنيه</div>
                </div>
                <div style="background: #fff3f0; padding: 15px; border-radius: 8px; border-right: 4px solid #f44336;">
                    <div style="font-size: 13px; color: #666; margin-bottom: 5px;">تكلفة المكونات</div>
                    <div style="font-size: 24px; font-weight: bold; color: #f44336;" id="ingredientsCost">0 جنيه</div>
                </div>
                <div style="background: #f0fff4; padding: 15px; border-radius: 8px; border-right: 4px solid #4caf50;">
                    <div style="font-size: 13px; color: #666; margin-bottom: 5px;">صافي الربح</div>
                    <div style="font-size: 24px; font-weight: bold; color: #4caf50;" id="netProfit">0 جنيه</div>
                </div>
                <div style="background: #fff9e6; padding: 15px; border-radius: 8px; border-right: 4px solid #ff9800;">
                    <div style="font-size: 13px; color: #666; margin-bottom: 5px;">الخسائر</div>
                    <div style="font-size: 24px; font-weight: bold; color: #ff9800;" id="totalLosses">0 جنيه</div>
                </div>
            </div>
        </div>

        <!-- المخزون والطلبات -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <!-- حالة المخزون -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h2 style="margin: 0 0 20px 0; font-size: 18px;">📦 حالة المخزون</h2>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: #d4edda; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: bold; color: #155724;" id="stockAvailable">0</div>
                        <div style="font-size: 13px; color: #155724;">✅ متوفر</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fff3cd; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: bold; color: #856404;" id="stockLow">0</div>
                        <div style="font-size: 13px; color: #856404;">⚠️ منخفض</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8d7da; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: bold; color: #721c24;" id="stockCritical">0</div>
                        <div style="font-size: 13px; color: #721c24;">🔴 حرج</div>
                    </div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 13px; color: #666; margin-bottom: 5px;">قيمة المخزون الإجمالية</div>
                    <div style="font-size: 28px; font-weight: bold; color: #667eea;" id="inventoryValue">0 جنيه</div>
                </div>
                <div id="criticalItemsList" style="margin-top: 15px; max-height: 150px; overflow-y: auto;"></div>
            </div>

            <!-- إحصائيات الطلبات -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h2 style="margin: 0 0 20px 0; font-size: 18px;">📈 تفصيل الطلبات</h2>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; padding: 12px; background: #f0fff4; border-radius: 6px; border-right: 3px solid #4caf50;">
                        <span style="font-weight: 600;">✅ مكتملة</span>
                        <span style="font-weight: bold; color: #4caf50;" id="completedOrders">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px; background: #fff3e0; border-radius: 6px; border-right: 3px solid #ff9800;">
                        <span style="font-weight: 600;">🔄 قيد التحضير</span>
                        <span style="font-weight: bold; color: #ff9800;" id="preparingOrdersStat">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px; background: #e3f2fd; border-radius: 6px; border-right: 3px solid #2196f3;">
                        <span style="font-weight: 600;">🆕 جديدة</span>
                        <span style="font-weight: bold; color: #2196f3;" id="newOrdersStat">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px; background: #ffebee; border-radius: 6px; border-right: 3px solid #f44336;">
                        <span style="font-weight: 600;">❌ ملغاة</span>
                        <span style="font-weight: bold; color: #f44336;" id="cancelledOrders">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9f9f9; border-radius: 6px;">
                        <span style="font-weight: 600;">🍽️ داخلي (Dine-in)</span>
                        <span style="font-weight: bold;" id="dineInOrders">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9f9f9; border-radius: 6px;">
                        <span style="font-weight: 600;">🛵 توصيل (Delivery)</span>
                        <span style="font-weight: bold;" id="deliveryOrders">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- الطاولات والديليفري -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <!-- حالة الطاولات -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h2 style="margin: 0 0 20px 0; font-size: 18px;">🍽️ حالة الطاولات</h2>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 12px; background: #d4edda; border-radius: 6px;">
                        <div style="font-size: 24px; font-weight: bold; color: #155724;" id="tablesAvailable">0</div>
                        <div style="font-size: 12px; color: #155724;">متاحة</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: #f8d7da; border-radius: 6px;">
                        <div style="font-size: 24px; font-weight: bold; color: #721c24;" id="tablesOccupied">0</div>
                        <div style="font-size: 12px; color: #721c24;">مشغولة</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: #fff3cd; border-radius: 6px;">
                        <div style="font-size: 24px; font-weight: bold; color: #856404;" id="tablesReserved">0</div>
                        <div style="font-size: 12px; color: #856404;">محجوزة</div>
                    </div>
                </div>
                <div style="background: #f9f9f9; padding: 12px; border-radius: 6px;">
                    <div style="font-size: 13px; color: #666; margin-bottom: 8px;">نسبة الإشغال</div>
                    <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div id="occupancyBar" style="background: linear-gradient(90deg, #4caf50 0%, #ff9800 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div style="text-align: center; margin-top: 5px; font-weight: bold; font-size: 16px; color: #667eea;" id="occupancyRate">0%</div>
                </div>
            </div>

            <!-- حالة التوصيل -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h2 style="margin: 0 0 20px 0; font-size: 18px;">🛵 حالة التوصيل</h2>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #fff3e0; border-radius: 6px;">
                        <span>قيد التحضير</span>
                        <span style="font-weight: bold;" id="deliveryPreparing">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #e3f2fd; border-radius: 6px;">
                        <span>جاهز للتوصيل</span>
                        <span style="font-weight: bold;" id="deliveryReady">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #fff9c4; border-radius: 6px;">
                        <span>في الطريق</span>
                        <span style="font-weight: bold;" id="deliveryOnWay">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #d4edda; border-radius: 6px;">
                        <span>تم التوصيل اليوم</span>
                        <span style="font-weight: bold;" id="deliveryDelivered">0</span>
                    </div>
                </div>
                <div style="background: #f9f9f9; padding: 12px; border-radius: 6px; margin-top: 15px; text-align: center;">
                    <div style="font-size: 13px; color: #666; margin-bottom: 5px;">متوسط وقت التوصيل</div>
                    <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="avgDeliveryTime">0 دقيقة</div>
                </div>
            </div>

            <!-- أكثر الأصناف مبيعاً -->
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h2 style="margin: 0 0 20px 0; font-size: 18px;">🏆 أكثر الأصناف مبيعاً</h2>
                <div id="topSellingItems" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>

        <!-- التبويبات -->
        <div class="tabs">
            <button class="tab-btn active" onclick="AdminDashboard.switchTab('current')">الطلبات الحالية</button>
            <button class="tab-btn" onclick="AdminDashboard.switchTab('orders')">جميع الطلبات</button>
            <button class="tab-btn" onclick="AdminDashboard.switchTab('users')">المستخدمين</button>
            <button class="tab-btn" onclick="AdminDashboard.switchTab('deliveries')">التوصيل</button>
            <button class="tab-btn" onclick="AdminDashboard.switchTab('inventory')">المخزون</button>
            <button class="tab-btn" onclick="AdminDashboard.switchTab('hr')">👥 الموظفين</button>
            <button class="tab-btn" onclick="AdminDashboard.switchTab('expenses')">💰 المصروفات</button>
            <button class="tab-btn" onclick="AdminDashboard.switchTab('exports')">📊 التقارير</button>
        </div>
        <!-- Current Orders Tab -->
        <div id="currentTab" class="tab-content active">
            <h2>الطلبات الحالية</h2>
            <table>
                <thead>
                    <tr>
                        <th>رقم الطلب</th>
                        <th>النوع</th>
                        <th>الطاولة/العميل</th>
                        <th>الحالة</th>
                        <th>الإجمالي</th>
                        <th>الوقت</th>
                    </tr>
                </thead>
                <tbody id="currentOrdersBody"></tbody>
            </table>
        </div>

        <!-- Orders Tab -->
        <div id="ordersTab" class="tab-content">
            <div class="filters">
                <input type="date" id="orderDateFrom" placeholder="من تاريخ">
                <input type="date" id="orderDateTo" placeholder="إلى تاريخ">
                <select id="orderTypeFilter">
                    <option value="">جميع الأنواع</option>
                    <option value="dine_in">داخلي</option>
                    <option value="delivery">توصيل</option>
                </select>
                <select id="orderStatusFilter">
                    <option value="">جميع الحالات</option>
                    <option value="new">جديد</option>
                    <option value="preparing">قيد التحضير</option>
                    <option value="ready">جاهز</option>
                    <option value="completed">مكتمل</option>
                </select>
                <button class="btn btn-primary" onclick="AdminDashboard.filterOrders()">بحث</button>
                <button class="btn btn-export" onclick="AdminDashboard.exportOrders()">تصدير Excel</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>رقم الطلب</th>
                        <th>التاريخ</th>
                        <th>النوع</th>
                        <th>الطاولة/العميل</th>
                        <th>الموظف</th>
                        <th>الإجمالي</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody id="ordersBody"></tbody>
            </table>
        </div>

        <!-- Users Tab -->
        <div id="usersTab" class="tab-content">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="AdminDashboard.openAddUserModal()">➕ إضافة مستخدم</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>اسم المستخدم</th>
                        <th>الدور</th>
                        <th>الموبايل</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="usersBody"></tbody>
            </table>
        </div>

        <!-- Deliveries Tab -->
        <div id="deliveriesTab" class="tab-content">
            <table>
                <thead>
                    <tr>
                        <th>رقم الطلب</th>
                        <th>اسم العميل</th>
                        <th>الموبايل</th>
                        <th>العنوان</th>
                        <th>المندوب</th>
                        <th>رسوم التوصيل</th>
                        <th>الحالة</th>
                        <th>الوقت</th>
                    </tr>
                </thead>
                <tbody id="deliveriesBody"></tbody>
            </table>
        </div>

        <!-- Inventory Tab -->
        <div id="inventoryTab" class="tab-content">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="window.location.href='inventory.html'">إدارة المخزون الكاملة</button>
                <button class="btn btn-export" onclick="AdminDashboard.exportInventory()">تصدير Excel</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>المكون</th>
                        <th>الكمية الحالية</th>
                        <th>الوحدة</th>
                        <th>الحد الأدنى</th>
                        <th>التكلفة لكل وحدة</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
            </table>
        </div>

        <!-- ========================================
             قسم إدارة الموظفين - جديد
             ======================================== -->
        <div id="hrTab" class="tab-content">
            <h2 style="margin-bottom: 20px;">👥 إدارة الموظفين والحضور</h2>

            <!-- Sub-tabs -->
            <div class="tabs" style="margin-bottom: 20px;">
                <button class="tab-btn active" onclick="switchHRSubTab('employees')">الموظفين</button>
                <button class="tab-btn" onclick="switchHRSubTab('attendance')">الحضور اليومي</button>
                <button class="tab-btn" onclick="switchHRSubTab('salaries')">الرواتب</button>
            </div>

            <!-- تبويب: الموظفين -->
            <div id="employees-subtab" class="tab-content active">
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="openAddEmployeeModal()">➕ إضافة موظف</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الوظيفة</th>
                            <th>الهاتف</th>
                            <th>الراتب اليومي</th>
                            <th>تاريخ التعيين</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="employeesBody"></tbody>
                </table>
            </div>

            <!-- تبويب: الحضور -->
            <div id="attendance-subtab" class="tab-content">
                <div style="background: white; padding: 20px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>تسجيل الحضور - <span id="attendance-date-display"></span></h3>
                        <input type="date" id="attendance-date-picker" class="form-input" style="width: 200px;">
                    </div>
                    <div id="attendance-list"></div>
                    <button class="btn btn-success" onclick="saveAttendance()" style="margin-top: 20px;">💾 حفظ الحضور</button>
                </div>
            </div>

            <!-- تبويب: الرواتب -->
            <div id="salaries-subtab" class="tab-content">
                <div style="background: white; padding: 20px; border-radius: 8px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                        <input type="date" id="salary-from" class="form-input" placeholder="من">
                        <input type="date" id="salary-to" class="form-input" placeholder="إلى">
                        <button class="btn btn-info" onclick="loadSalaryReport()">عرض التقرير</button>
                        <button class="btn btn-success" onclick="exportSalariesExcel()">📊 تصدير Excel</button>
                    </div>
                    <div id="salary-report"></div>
                </div>
            </div>
        </div>

        <!-- ========================================
             قسم المصروفات والفواتير - جديد
             ======================================== -->
        <div id="expensesTab" class="tab-content">
            <h2 style="margin-bottom: 20px;">💰 إدارة المصروفات والفواتير</h2>

            <!-- Sub-tabs -->
            <div class="tabs" style="margin-bottom: 20px;">
                <button class="tab-btn active" onclick="switchExpenseSubTab('suppliers')">الموردين</button>
                <button class="tab-btn" onclick="switchExpenseSubTab('invoices')">فواتير الموردين</button>
                <button class="tab-btn" onclick="switchExpenseSubTab('general')">المصروفات العامة</button>
            </div>

            <!-- تبويب: الموردين -->
            <div id="suppliers-subtab" class="tab-content active">
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="openAddSupplierModal()">➕ إضافة مورد</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الهاتف</th>
                            <th>الفئة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="suppliersBody"></tbody>
                </table>
            </div>

            <!-- تبويب: فواتير الموردين -->
            <div id="invoices-subtab" class="tab-content">
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="openAddInvoiceModal()">➕ إضافة فاتورة</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>رقم الفاتورة</th>
                            <th>المورد</th>
                            <th>التاريخ</th>
                            <th>المبلغ</th>
                            <th>المدفوع</th>
                            <th>المتبقي</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesBody"></tbody>
                </table>
            </div>

            <!-- تبويب: المصروفات العامة -->
            <div id="general-subtab" class="tab-content">
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="openAddExpenseModal()">➕ إضافة مصروف</button>
                    <button class="btn btn-export" onclick="exportExpensesExcel()">📊 تصدير Excel</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>النوع</th>
                            <th>التاريخ</th>
                            <th>المبلغ</th>
                            <th>المدفوع إلى</th>
                            <th>الوصف</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ========================================
             قسم تصدير Excel - جديد
             ======================================== -->
        <div id="exportsTab" class="tab-content">
            <h2 style="margin-bottom: 30px; text-align: center;">📊 تصدير التقارير المالية إلى Excel</h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <!-- تصدير المبيعات -->
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">📈</div>
                    <h3 style="margin-bottom: 10px;">تقرير المبيعات</h3>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">تصدير تفاصيل المبيعات مع الأرباح والتكاليف</p>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                        <input type="date" id="sales-export-from" placeholder="من تاريخ" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <input type="date" id="sales-export-to" placeholder="إلى تاريخ" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <button class="btn btn-success" onclick="exportSalesExcel()" style="width: 100%;">
                        📊 تصدير المبيعات
                    </button>
                </div>

                <!-- تصدير الرواتب -->
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">👥</div>
                    <h3 style="margin-bottom: 10px;">تقرير الرواتب</h3>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">تصدير رواتب الموظفين مع الحضور والغياب</p>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                        <input type="date" id="salary-export-from" placeholder="من تاريخ" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <input type="date" id="salary-export-to" placeholder="إلى تاريخ" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <button class="btn btn-success" onclick="exportSalariesExcel()" style="width: 100%;">
                        📊 تصدير الرواتب
                    </button>
                </div>

                <!-- تصدير المصروفات -->
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">💰</div>
                    <h3 style="margin-bottom: 10px;">تقرير المصروفات</h3>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">تصدير جميع المصروفات والفواتير</p>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                        <input type="date" id="expense-export-from" placeholder="من تاريخ" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <input type="date" id="expense-export-to" placeholder="إلى تاريخ" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <button class="btn btn-success" onclick="exportExpensesExcel()" style="width: 100%;">
                        📊 تصدير المصروفات
                    </button>
                </div>

                <!-- تصدير شامل -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(102,126,234,0.4); text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">📊</div>
                    <h3 style="margin-bottom: 10px; color: white;">التقرير المالي الشامل</h3>
                    <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px; font-size: 14px;">تقرير كامل: مبيعات - مصروفات - رواتب - صافي الربح</p>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                        <input type="date" id="full-export-from" placeholder="من تاريخ" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.2); color: white;">
                        <input type="date" id="full-export-to" placeholder="إلى تاريخ" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.2); color: white;">
                    </div>
                    <button class="btn btn-primary" onclick="exportFullFinancialReport()" style="width: 100%; background: white; color: #667eea; font-weight: bold;">
                        📊 تصدير التقرير الشامل
                    </button>
                </div>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; text-align: center;">
                <p style="color: #666; margin-bottom: 10px;">💡 <strong>ملاحظة:</strong> جميع التقارير تحتوي على:</p>
                <ul style="list-style: none; padding: 0; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                    <li>✅ تفاصيل كاملة</li>
                    <li>✅ حسابات تلقائية</li>
                    <li>✅ صافي الربح</li>
                    <li>✅ جاهز للمحاسبين</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Modal: Add User -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إضافة مستخدم جديد</h2>
                <span class="close-modal" onclick="AdminDashboard.closeAddUserModal()">×</span>
            </div>
            <form id="addUserForm">
                <div class="form-group">
                    <label>الاسم الكامل *</label>
                    <input type="text" id="userFullName" required>
                </div>
                <div class="form-group">
                    <label>اسم المستخدم *</label>
                    <input type="text" id="userUsername" required>
                </div>
                <div class="form-group">
                    <label>كلمة المرور *</label>
                    <input type="password" id="userPassword" required>
                </div>
                <div class="form-group">
                    <label>الدور *</label>
                    <select id="userRole" required>
                        <option value="">-- اختر --</option>
                        <option value="admin">مدير</option>
                        <option value="cashier">كاشير</option>
                        <option value="staff">موظف</option>
                        <option value="kitchen">مطبخ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>رقم الموبايل</label>
                    <input type="tel" id="userPhone">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">حفظ المستخدم</button>
            </form>
        </div>
    </div>
    <!-- Modal: إضافة موظف -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إضافة موظف جديد</h2>
                <span class="close-modal" onclick="closeModal('addEmployeeModal')">×</span>
            </div>
            <form id="addEmployeeForm" onsubmit="saveEmployee(event)">
                <div class="form-group">
                    <label>اسم الموظف *</label>
                    <input type="text" id="employeeName" required>
                </div>
                <div class="form-group">
                    <label>الوظيفة *</label>
                    <input type="text" id="employeePosition" required>
                </div>
                <div class="form-group">
                    <label>الهاتف</label>
                    <input type="tel" id="employeePhone">
                </div>
                <div class="form-group">
                    <label>الراتب اليومي *</label>
                    <input type="number" id="employeeSalary" required step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>تاريخ التعيين *</label>
                    <input type="date" id="employeeHireDate" required>
                </div>
                <div class="form-group">
                    <label>ملاحظات</label>
                    <textarea id="employeeNotes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">حفظ الموظف</button>
            </form>
        </div>
    </div>

    <!-- Modal: إضافة مورد -->
    <div id="addSupplierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إضافة مورد جديد</h2>
                <span class="close-modal" onclick="closeModal('addSupplierModal')">×</span>
            </div>
            <form id="addSupplierForm" onsubmit="saveSupplier(event)">
                <div class="form-group">
                    <label>اسم المورد *</label>
                    <input type="text" id="supplierName" required>
                </div>
                <div class="form-group">
                    <label>الهاتف</label>
                    <input type="tel" id="supplierPhone">
                </div>
                <div class="form-group">
                    <label>الفئة</label>
                    <input type="text" id="supplierCategory" placeholder="مثال: خضروات، لحوم، بقالة">
                </div>
                <div class="form-group">
                    <label>العنوان</label>
                    <textarea id="supplierAddress" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">حفظ المورد</button>
            </form>
        </div>
    </div>

    <!-- Modal: إضافة فاتورة -->
    <div id="addInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إضافة فاتورة مورد</h2>
                <span class="close-modal" onclick="closeModal('addInvoiceModal')">×</span>
            </div>
            <form id="addInvoiceForm" onsubmit="saveInvoice(event)">
                <div class="form-group">
                    <label>المورد *</label>
                    <select id="invoiceSupplier" required>
                        <option value="">اختر المورد</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>رقم الفاتورة</label>
                    <input type="text" id="invoiceNumber" placeholder="اختياري">
                </div>
                <div class="form-group">
                    <label>التاريخ *</label>
                    <input type="date" id="invoiceDate" required>
                </div>
                <div class="form-group">
                    <label>المبلغ الإجمالي *</label>
                    <input type="number" id="invoiceAmount" required step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>المبلغ المدفوع</label>
                    <input type="number" id="invoicePaid" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>الوصف</label>
                    <textarea id="invoiceDescription" rows="3" placeholder="تفاصيل الفاتورة..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">💾 حفظ وطباعة</button>
            </form>
        </div>
    </div>

    <!-- Modal: إضافة مصروف -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إضافة مصروف عام</h2>
                <span class="close-modal" onclick="closeModal('addExpenseModal')">×</span>
            </div>
            <form id="addExpenseForm" onsubmit="saveExpense(event)">
                <div class="form-group">
                    <label>نوع المصروف *</label>
                    <select id="expenseType" required>
                        <option value="">اختر النوع</option>
                        <option value="electricity">⚡ كهرباء</option>
                        <option value="water">💧 مياه</option>
                        <option value="internet">🌐 إنترنت</option>
                        <option value="gas">🔥 غاز</option>
                        <option value="rent">🏠 إيجار</option>
                        <option value="maintenance">🔧 صيانة</option>
                        <option value="other">📌 أخرى</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>التاريخ *</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group">
                    <label>المبلغ *</label>
                    <input type="number" id="expenseAmount" required step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>المدفوع إلى</label>
                    <input type="text" id="expensePaidTo" placeholder="اسم الشركة أو الشخص">
                </div>
                <div class="form-group">
                    <label>الوصف</label>
                    <textarea id="expenseDescription" rows="3" placeholder="تفاصيل المصروف..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">💾 حفظ وطباعة</button>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="config/keys.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/realtime.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/hr-management.js"></script>
    
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            AdminDashboard.init();
            
            // تهيئة التواريخ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date-picker').value = today;
            document.getElementById('employeeHireDate').value = today;
            document.getElementById('invoiceDate').value = today;
            document.getElementById('expenseDate').value = today;
            
            // تحميل البيانات الأولية
            if (typeof loadEmployees !== 'undefined') loadEmployees();
            if (typeof loadSuppliers !== 'undefined') loadSuppliers();
        });

        // ===================================
        // وظائف التبويبات الفرعية
        // ===================================
        
        function switchHRSubTab(tabName) {
            // إخفاء جميع التبويبات الفرعية
            document.querySelectorAll('#hrTab .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إزالة active من الأزرار
            document.querySelectorAll('#hrTab .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // إظهار التبويب المطلوب
            document.getElementById(tabName + '-subtab').classList.add('active');
            event.target.classList.add('active');
            
            // تحميل البيانات حسب التبويب
            if (tabName === 'employees') {
                if (typeof loadEmployees !== 'undefined') loadEmployees();
            } else if (tabName === 'attendance') {
                if (typeof loadAttendance !== 'undefined') loadAttendance();
            } else if (tabName === 'salaries') {
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                document.getElementById('salary-from').value = firstDay.toISOString().split('T')[0];
                document.getElementById('salary-to').value = today.toISOString().split('T')[0];
            }
        }

        function switchExpenseSubTab(tabName) {
            // إخفاء جميع التبويبات الفرعية
            document.querySelectorAll('#expensesTab .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إزالة active من الأزرار
            document.querySelectorAll('#expensesTab .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // إظهار التبويب المطلوب
            document.getElementById(tabName + '-subtab').classList.add('active');
            event.target.classList.add('active');
            
            // تحميل البيانات
            if (tabName === 'suppliers') {
                if (typeof loadSuppliers !== 'undefined') loadSuppliers();
            } else if (tabName === 'invoices') {
                if (typeof loadInvoices !== 'undefined') loadInvoices();
            } else if (tabName === 'general') {
                if (typeof loadGeneralExpenses !== 'undefined') loadGeneralExpenses();
            }
        }

        // ===================================
        // وظائف Modals
        // ===================================
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openAddEmployeeModal() {
            document.getElementById('addEmployeeModal').style.display = 'flex';
            document.getElementById('addEmployeeForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('employeeHireDate').value = today;
        }

        function openAddSupplierModal() {
            document.getElementById('addSupplierModal').style.display = 'flex';
            document.getElementById('addSupplierForm').reset();
        }

        function openAddInvoiceModal() {
            document.getElementById('addInvoiceModal').style.display = 'flex';
            document.getElementById('addInvoiceForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;
            
            // تحميل قائمة الموردين
            if (typeof loadSuppliersForInvoice !== 'undefined') {
                loadSuppliersForInvoice();
            }
        }

        function openAddExpenseModal() {
            document.getElementById('addExpenseModal').style.display = 'flex';
            document.getElementById('addExpenseForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
        }

        // إغلاق Modal عند الضغط خارجها
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>

    <!-- ===================================
         نظام Refresh والاتصال الذكي
         =================================== -->
    <style>
      .refresh-widget {
        position: fixed;
        bottom: 30px;
        right: 30px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 9998;
      }

      .refresh-btn-main {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 26px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .refresh-btn-main:hover {
        transform: scale(1.1) rotate(15deg);
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.7);
      }

      .refresh-btn-main.refreshing {
        animation: rotate360 1s linear infinite;
      }

      @keyframes rotate360 {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .refresh-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #f44336;
        color: white;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        font-size: 11px;
        font-weight: bold;
        display: none;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
      }

      .refresh-badge.show {
        display: flex;
      }

      .connection-status {
        background: white;
        padding: 10px 15px;
        border-radius: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 600;
      }

      .connection-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        animation: pulse-dot 2s infinite;
      }

      .connection-status.connected .connection-dot {
        background: #4caf50;
      }

      .connection-status.disconnected .connection-dot {
        background: #f44336;
      }

      @keyframes pulse-dot {
        0%, 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
        50% { box-shadow: 0 0 0 6px rgba(76, 175, 80, 0); }
      }

      @media (max-width: 768px) {
        .refresh-widget {
          bottom: 20px;
          right: 20px;
        }
        .refresh-btn-main {
          width: 50px;
          height: 50px;
        }
      }
    </style>

    <div class="refresh-widget">
      <button class="refresh-btn-main" id="refreshBtn" onclick="refreshData()" title="تحديث البيانات">
        🔄
        <span class="refresh-badge" id="refreshBadge">0</span>
      </button>
      
      <div class="connection-status checking" id="connectionStatus">
        <span class="connection-dot"></span>
        <span id="connectionText">جاري الفحص...</span>
      </div>
    </div>

    <script>
    let isRefreshing = false;

    async function checkConnection() {
      const statusElement = document.getElementById('connectionStatus');
      const textElement = document.getElementById('connectionText');
      
      try {
        const { error } = await supabase.from('orders').select('id').limit(1);
        if (error) throw error;
        
        statusElement.className = 'connection-status connected';
        textElement.textContent = 'متصل';
        return true;
      } catch (error) {
        statusElement.className = 'connection-status disconnected';
        textElement.textContent = 'غير متصل';
        return false;
      }
    }

    async function refreshData() {
      if (isRefreshing) return;
      
      isRefreshing = true;
      const btn = document.getElementById('refreshBtn');
      btn.classList.add('refreshing');
      
      try {
        if (typeof AdminDashboard !== 'undefined' && AdminDashboard.loadAllData) {
          await AdminDashboard.loadAllData();
        }
        await checkConnection();
      } catch (error) {
        console.error('Refresh error:', error);
      } finally {
        isRefreshing = false;
        btn.classList.remove('refreshing');
      }
    }

    window.addEventListener('DOMContentLoaded', async () => {
      await checkConnection();
      setInterval(checkConnection, 30000);
      setInterval(refreshData, 2 * 60 * 1000);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
        e.preventDefault();
        refreshData();
      }
    });
    </script>
</body>
</html>
